import os
import hashlib
import numpy as np
from sklearn.svm import SVC
from sklearn.model_selection import train_test_split
from sklearn.feature_extraction import FeatureHasher
import joblib

MODEL_PATH = "../model/malware_model.joblib"
HASH_DB_PATH = "../model/known_malware_hashes.txt"

# Simulasi database hash malware (untuk demo)
KNOWN_MALWARE_HASHES = {
    "e1c1d2b3a4f5e6d7c8b9a0f1e2d3c4b5a6d7e8f9",  # contoh hash palsu
}

def extract_features(file_path):
    """Ekstrak fitur sederhana: ukuran file + entropy byte"""
    with open(file_path, "rb") as f:
        data = f.read()
    
    size = len(data)
    if size == 0:
        entropy = 0
    else:
        # Hitung entropy sederhana
        freq = np.bincount(np.frombuffer(data, dtype=np.uint8), minlength=256)
        prob = freq / size
        prob = prob[prob > 0]
        entropy = -np.sum(prob * np.log2(prob))
    
    return np.array([size, entropy]).reshape(1, -1)

def is_known_malware(file_path):
    with open(file_path, "rb") as f:
        sha1 = hashlib.sha1(f.read()).hexdigest()
    return sha1 in KNOWN_MALWARE_HASHES

def load_or_train_model():
    if os.path.exists(MODEL_PATH):
        return joblib.load(MODEL_PATH)
    
    # Buat data dummy untuk pelatihan (DUMMY â€” jangan digunakan di produksi!)
    X = np.random.rand(100, 2)  # [size, entropy]
    y = np.random.choice([0, 1], size=100)  # 0 = clean, 1 = malware
    model = SVC(kernel='rbf', probability=True)
    model.fit(X, y)
    joblib.dump(model, MODEL_PATH)
    return model

def predict_malware(file_path, model):
    features = extract_features(file_path)
    prob = model.predict_proba(features)[0]
    malware_prob = prob[1]  # probabilitas kelas malware
    return malware_prob > 0.7, malware_prob  # threshold 70%
